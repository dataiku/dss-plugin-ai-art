AI Art
%%%%%%

This plugin allows you to generate images from text using
`Stable Diffusion <stable-diffusion-wiki_>`_

.. figure:: _static/pirate-ship.png
   :alt: A pirate ship sailing in outer space

   An image generated by AI Art using the prompt "A pirate ship sailing in outer
   space"

How to set up
=============

CUDA
----
A CUDA-capable GPU with at least 6 GB of VRAM is recommended.
You can run the plugin without a GPU, but it will be significantly slower.

If you're using a CUDA GPU, your GPU must support CUDA 11.6, and the NVIDIA
drivers must be installed on the server. For installation instructions, see
`NVIDIA Driver Installation Quickstart Guide <nvidia-install-guide_>`_.

Download weights
----------------
Before you can use the plugin, you need to download pre-trained weights to a
local managed folder. The plugin is designed to work with version 2 of the
Stable Diffusion weights, although it may work with other versions and
derivatives as well.

For example, if you run the below code in a notebook, it will download the
Stability AI version 2.1 weights, and upload them to a new managed folder.

The code requires a code environment with the *huggingface-hub* package
installed.

.. warning::
   The weights available from Stability AI are licensed under the CreativeML
   OpenRAIL++-M license, which restricts usage. You can view the license
   `here <stabilityai-license_>`_.

.. code-block:: python

   import tempfile

   import dataiku
   import huggingface_hub

   # Name of the local folder that will be created
   FOLDER_NAME = "my_weights"
   # Hugging Face repository
   REPO = "stabilityai/stable-diffusion-2-1"
   # Revision of the repository
   #
   # If using the Stability AI weights, the "fp16" revision is recommended
   # if using CUDA. Otherwise, use the "main" revision.
   REVISION = "fp16"

   client = dataiku.api_client()
   project = client.get_default_project()

   # Create the managed folder
   folder = project.create_managed_folder(FOLDER_NAME)

   with tempfile.TemporaryDirectory(dir=".") as temp_dir:
       # Download the weights to a temp local dir
       huggingface_hub.snapshot_download(
          repo_id=REPO,
          revision=REVISION,
          local_dir=temp_dir,
          local_dir_use_symlinks=False,
          # Skip large files that the plugin doesn't need
          ignore_patterns=["*.ckpt", "*.safetensors"],
       )

       # Upload the weights to the managed folder
       folder.upload_folder("/", temp_dir)

Using a folder that's stored on the local filesystem is recommended. If the
folder is stored on a remote connection (Amazon S3, Google Cloud Storage, etc),
the weights will be downloaded to a temporary directory every time the recipe is
run.

How to use
==========
AI Art contains two methods for generating images: Text-to-Image Generation, and
Text-Guided Image-to-Image Generation

Text-to-Image Generation
------------------------
Text-to-Image Generation is used to generate images from a text prompt.

.. image:: _static/text-to-image.png
   :alt: Diagram showing how Text-to-Image Generation works

.. image:: _static/instructions-text-to-image-1.png
   :alt: Screenshot showing what the Flow looks like when using the recipe

#.  Create a *Text-to-Image Generation* recipe with your weights folder as the
    input.

#.  Enter a text prompt in the *Prompt* field.

#.  If you're using the *fp16* revision of the weights, be sure to check the
    *Half precision* field.

.. image:: _static/instructions-text-to-image-2.png
   :alt: Screenshot of the recipe settings

Text-Guided Image-to-Image Generation
-------------------------------------
Text-Guided Image-to-Image Generation is used to modify an existing reference
image based on a text prompt.

.. image:: _static/text-guided-image-to-image.png
   :alt: Diagram showing how Text-Guided Image-to-Image Generation works

.. image:: _static/instructions-text-guided-image-to-image-1.png
   :alt: Screenshot showing what the Flow looks like when using the recipe

#.  Obtain a reference image that you want to use as a base, and upload it to a
    managed folder.

#.  Create a *Text-Guided Image-to-Image Generation* recipe with your weights
    folder and your base-image folder as the inputs.

#.  Enter a text prompt in the *Prompt* field.

#.  Enter the path to your base image in the *Base image* field.

#.  If you're using the *fp16* revision of the weights, be sure to check the
    *Half precision* field.

.. image:: _static/instructions-text-guided-image-to-image-2.png
   :alt: Screenshot of the recipe settings

.. _stabilityai-license: https://huggingface.co/stabilityai/stable-diffusion-2/raw/main/LICENSE-MODEL
.. _git-lfs: https://git-lfs.github.com/
.. _stable-diffusion-wiki: https://en.wikipedia.org/wiki/Stable_Diffusion
.. _homebrew: https://brew.sh/
.. _nvidia-install-guide: https://docs.nvidia.com/datacenter/tesla/tesla-installation-notes/index.html
